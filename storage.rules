rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ───── Verification Documents ─────
    match /verification-documents/{userType}/{userId}/{documentName} {
      function isOwner() {
        return request.auth.uid == userId;
      }
      function isEmployee() {
        return get(/databases/(default)/documents/users/$(request.auth.uid)).data.userType == 'employee';
      }
      function isValidDocument() {
        // This rule is no longer needed as path is specific
        return true;
      }
      function isValidSize() {
        return request.resource.size < 5 * 1024 * 1024; // 5 MB
      }
      function isValidType() {
        return request.resource.contentType.matches('image/.*|application/pdf');
      }

      allow read: if request.auth != null && (isOwner() || isEmployee());
      allow write: if request.auth != null && isOwner() && isValidSize() && isValidType();
    }
    
    // ───── Shipment Documents ─────
    match /shipments/{shipmentId}/{fileId} {
       function isEmployee() {
        return get(/databases/(default)/documents/users/$(request.auth.uid)).data.userType == 'employee';
      }
      function isShipmentParticipant() {
        let shipment = get(/databases/(default)/documents/shipments/$(shipmentId)).data;
        return request.auth.uid == shipment.exporterId || request.auth.uid == shipment.winningCarrierId;
      }
      function isValidSize() {
          return request.resource.size < 5 * 1024 * 1024; // 5 MB
      }
      function isValidType() {
        return request.resource.contentType.matches('image/.*|application/pdf|application/msword|application/vnd.openxmlformats-officedocument.wordprocessingml.document');
      }
      function isOwnerOfFile() {
        // Check if the filename starts with the user's UID
        return fileId.matches(request.auth.uid + '_.*');
      }

      allow read: if request.auth != null && (isShipmentParticipant() || isEmployee());
      allow write: if request.auth != null && isShipmentParticipant() && isOwnerOfFile() && isValidSize() && isValidType();
    }

    // ───── Default Deny Rule ─────
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}