
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ───── Verification Documents ─────
    // Documents are organized by user type (exporter/carrier) and then by user ID.
    match /verification-documents/{userType}/{userId}/{allPaths=**} {

      // Helper: check if the current user is an employee
      function isEmployee() {
        return get(/databases/(default)/documents/users/$(request.auth.uid)).data.userType == 'employee';
      }

      // Helper: check if the current user is the document owner
      function isOwner() {
        return request.auth.uid == userId;
      }

      // READ: Owner or employee can read their respective documents.
      allow read: if request.auth != null && (isOwner() || isEmployee());

      // WRITE: Only the owner can upload their own verification documents.
      allow write: if request.auth != null && isOwner();
    }

    // ───── Default Deny Rule ─────
    // All other paths in storage are locked down by default.
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
