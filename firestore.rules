rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an authenticated employee
    function isEmployee() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'employee';
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Users can read and update their own document.
      // Employees can read any user document.
      allow read, update: if request.auth.uid == userId || isEmployee();
      // Only authenticated users can create their own user document.
      allow create: if request.auth.uid == userId;
    }

    // Rules for the 'shipments' collection
    match /shipments/{shipmentId} {
      // Anyone authenticated can read shipment details.
      allow read: if request.auth.uid != null;

      // Exporters can create shipments for themselves.
      allow create: if request.auth.uid == request.resource.data.exporterId;

      // Update rules for shipments
      allow update: if
          // Rule 1: Exporter can update their own shipment if it's a draft or scheduled
          (request.auth.uid == resource.data.exporterId && (resource.data.status == 'draft' || resource.data.status == 'scheduled')) ||
          // Rule 2: Employee can update any shipment (e.g., to go-live)
          isEmployee() ||
          // Rule 3: Enforce data integrity when a shipment is awarded
          (
            request.resource.data.status == 'awarded' &&
            resource.data.status == 'live' &&
            (request.auth.uid == resource.data.exporterId || isEmployee()) &&
            // The provided winningCarrierLegalName must match the carrier's actual legal name from their profile
            request.resource.data.winningCarrierLegalName == get(/databases/$(database)/documents/users/$(request.resource.data.winningCarrierId)).data.companyDetails.legalName
          );

      // Deletion rules for shipments
      allow delete: if
          // Exporter can delete their own shipment only if it's a draft.
          (request.auth.uid == resource.data.exporterId && resource.data.status == 'draft') ||
          // Employees can delete any shipment.
          isEmployee();

      // Nested 'bids' subcollection rules
      match /bids/{bidId} {
        // Authenticated users can read bids.
        allow read: if request.auth.uid != null;
        // Carriers can only place bids on 'live' shipments.
        allow create: if get(/databases/$(database)/documents/shipments/$(shipmentId)).data.status == 'live' &&
                         exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'carrier' &&
                         request.auth.uid == request.resource.data.carrierId;
      }

      // Nested 'register' subcollection rules
      match /register/{carrierId} {
         // Authenticated users can read registration info
         allow read: if request.auth.uid != null;
         // A carrier can register their own interest for a scheduled shipment.
         allow create: if request.auth.uid == carrierId &&
                          get(/databases/$(database)/documents/shipments/$(shipmentId)).data.status == 'scheduled';
      }
    }
  }
}
