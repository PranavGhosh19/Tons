rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is an exporter
    function isExporter(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'exporter';
    }

    // Helper function to check if user is a carrier
    function isCarrier(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'carrier';
    }

    // Users can only read and write their own data
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId && request.resource.data.email == request.auth.token.email;
    }

    // Rules for the shipments collection
    match /shipments/{shipmentId} {
      // Exporters can create shipments for themselves
      allow create: if request.auth.uid != null && isExporter(request.auth.uid) && request.resource.data.exporterId == request.auth.uid;

      // Exporters can read/update their own shipments. Carriers can read all shipments.
      allow read: if request.auth.uid != null && (
                    (isExporter(request.auth.uid) && resource.data.exporterId == request.auth.uid) ||
                    isCarrier(request.auth.uid)
                  );
      allow update: if request.auth.uid != null && isExporter(request.auth.uid) && resource.data.exporterId == request.auth.uid;

      // Rules for the bids subcollection
      match /bids/{bidId} {
        // The shipment's exporter can read bids.
        allow read: if request.auth.uid != null && (
                      (isExporter(request.auth.uid) && get(/databases/$(database)/documents/shipments/$(shipmentId)).data.exporterId == request.auth.uid) ||
                      isCarrier(request.auth.uid) // Carriers can see other bids
                    );
        // Carriers can create bids for themselves
        allow create: if request.auth.uid != null && isCarrier(request.auth.uid) && request.resource.data.carrierId == request.auth.uid;
      }
    }
  }
}