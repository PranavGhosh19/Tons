rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is an exporter
    function isExporter(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'exporter';
    }

    // Helper function to check if user is a carrier
    function isCarrier(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'carrier';
    }

    // Users can only read and write their own data
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId && request.resource.data.email == request.auth.token.email;
    }

    // Rules for the shipments collection
    match /shipments/{shipmentId} {
      // Exporters can create shipments for themselves
      // - Must be an exporter
      // - Must set their own exporterId
      // - Must start with 'draft' status
      // - Must have a product name
      allow create: if request.auth.uid != null 
                    && isExporter(request.auth.uid) 
                    && request.resource.data.exporterId == request.auth.uid
                    && request.resource.data.status == 'draft'
                    && 'productName' in request.resource.data;

      // Exporters can read their own shipments. Carriers can read all shipments.
      allow read: if request.auth.uid != null && (
                    (isExporter(request.auth.uid) && resource.data.exporterId == request.auth.uid) ||
                    isCarrier(request.auth.uid)
                  );
      
      // Update rules are more complex
      allow update: if request.auth.uid != null 
                    && isExporter(request.auth.uid) 
                    && resource.data.exporterId == request.auth.uid
                    && isUpdateAllowed();

      // Rules for the bids subcollection
      match /bids/{bidId} {
        // Exporter of the shipment and all carriers can read bids.
        allow read: if request.auth.uid != null && (
                      (isExporter(request.auth.uid) && get(/databases/$(database)/documents/shipments/$(shipmentId)).data.exporterId == request.auth.uid) ||
                      isCarrier(request.auth.uid)
                    );
        // Carriers can create bids for themselves only on 'live' shipments.
        allow create: if request.auth.uid != null 
                      && isCarrier(request.auth.uid) 
                      && request.resource.data.carrierId == request.auth.uid
                      && get(/databases/$(database)/documents/shipments/$(shipmentId)).data.status == 'live';
      }
    }

    // Function to manage shipment update logic
    function isUpdateAllowed() {
      let isOwner = request.auth.uid == resource.data.exporterId;
      let incomingData = request.resource.data;
      let existingData = resource.data;
      let changingFields = incomingData.diff(existingData).affectedKeys();

      // Once a shipment is awarded, it is FINAL. No more changes.
      if (existingData.status == 'awarded') {
        return false;
      }
      
      // If a shipment is being edited (not changing status)
      if (incomingData.status == existingData.status) {
        // Can only edit if status is 'draft'
        // Cannot change immutable fields
        return existingData.status == 'draft' 
                && !('exporterId' in changingFields) 
                && !('createdAt' in changingFields);
      }

      // --- Handle Status Transitions ---

      // Transition: DRAFT -> LIVE
      if (existingData.status == 'draft' && incomingData.status == 'live') {
        // Only the status field should change
        return changingFields.size() == 1 && 'status' in changingFields;
      }
      
      // Transition: LIVE -> AWARDED
      if (existingData.status == 'live' && incomingData.status == 'awarded') {
        let allowedAwardFields = ['status', 'winningBidId', 'winningCarrierId', 'winningCarrierName', 'winningBidAmount'];
        // Ensure only the allowed fields are being changed for an award
        return changingFields.removeAll(allowedAwardFields).size() == 0
                && 'winningBidId' in incomingData
                && 'winningCarrierId' in incomingData
                && 'winningCarrierName' in incomingData
                && 'winningBidAmount' in incomingData;
      }

      // Transition: LIVE -> CLOSED
      if (existingData.status == 'live' && incomingData.status == 'closed') {
        // Only the status field should change
        return changingFields.size() == 1 && 'status' in changingFields;
      }

      // Deny all other transitions or updates
      return false;
    }
  }
}