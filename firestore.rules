rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is an exporter
    function isExporter(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'exporter';
    }

    // Helper function to check if user is a carrier
    function isCarrier(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'carrier';
    }

    // Users can only read and write their own data
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId && request.resource.data.email == request.auth.token.email;
    }

    // Rules for the shipments collection
    match /shipments/{shipmentId} {
      // Exporters can create shipments for themselves
      allow create: if request.auth.uid != null
                    && isExporter(request.auth.uid)
                    && request.resource.data.exporterId == request.auth.uid
                    && request.resource.data.status == 'draft'
                    && request.resource.data.productName is string
                    && request.resource.data.createdAt == request.time;


      // Exporters can read their own shipments. Carriers can read all shipments.
      allow read: if request.auth.uid != null && (
                    (isExporter(request.auth.uid) && resource.data.exporterId == request.auth.uid) ||
                    isCarrier(request.auth.uid)
                  );

      // Exporters can update their shipments under specific conditions
      allow update: if request.auth.uid != null
                    && isExporter(request.auth.uid)
                    && resource.data.exporterId == request.auth.uid
                    && request.resource.data.exporterId == resource.data.exporterId // Cannot change exporterId
                    && request.resource.data.createdAt == resource.data.createdAt // Cannot change createdAt
                    && (
                      // Condition 1: Editing a draft shipment
                      (resource.data.status == 'draft' && request.resource.data.status == 'draft') ||
                      // Condition 2: Going live from draft
                      (resource.data.status == 'draft' && request.resource.data.status == 'live') ||
                      // Condition 3: Awarding a bid on a live shipment
                      (resource.data.status == 'live' && request.resource.data.status == 'awarded' && request.resource.data.winningBidId is string)
                    );

      // Rules for the bids subcollection
      match /bids/{bidId} {
        // The shipment's exporter can read bids. Carriers can read all bids on a shipment.
        allow read: if request.auth.uid != null && (
                      isExporter(request.auth.uid) && get(/databases/$(database)/documents/shipments/$(shipmentId)).data.exporterId == request.auth.uid ||
                      isCarrier(request.auth.uid)
                    );

        // Carriers can create bids on live shipments for themselves
        allow create: if request.auth.uid != null
                      && isCarrier(request.auth.uid)
                      && request.resource.data.carrierId == request.auth.uid
                      && get(/databases/$(database)/documents/shipments/$(shipmentId)).data.status == 'live'; // Can only bid on live shipments
      }
    }
  }
}
