rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ───── Helper Functions ─────
    function isExporter(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'exporter';
    }

    function isCarrier(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'carrier';
    }

    // Employees are recognized only by company email domain
    function isEmployee() {
      return request.auth.token.email.matches('.*@shippingbattlefield\\.com$');
    }

    function getShipment(shipmentId) {
      return get(/databases/$(database)/documents/shipments/$(shipmentId));
    }

    function isShipmentAwardedParty(shipmentId, userId) {
      let shipment = getShipment(shipmentId).data;
      return shipment.status == 'awarded' && (
        isEmployee() ||
        shipment.exporterId == userId ||
        shipment.winningCarrierId == userId
      );
    }

    // ───── Users Collection ─────
    match /users/{userId} {
      // Employees can read all users; others can only read their own
      allow read: if request.auth.uid != null && (
        isEmployee() || request.auth.uid == userId
      );

      // Allow user to create their own document
      allow create: if request.auth.uid == userId &&
                     request.resource.data.email == request.auth.token.email;

      // Allow updates with constraints
      allow update: if request.auth.uid != null && (
        // Employees can update anyone
        isEmployee() ||

        // Users can only update themselves
        (request.auth.uid == userId && (
          // First-time verification submission
          (
            resource.data.verificationStatus == 'unsubmitted' &&
            request.resource.data.verificationStatus == 'pending' &&
            request.resource.data.companyDetails.incorporationCertificatePath.matches(
              'verification-documents/' + userId + '/.*'
            ) &&
            request.resource.data.companyDetails.keys().hasAll([
              'legalName', 'gstin', 'pan', 'iecCode', 'adCode',
              'incorporationCertificateUrl', 'incorporationCertificatePath'
            ])
          ) ||

          // General profile updates (can’t alter status/type)
          (
            request.resource.data.verificationStatus == resource.data.verificationStatus &&
            request.resource.data.userType == resource.data.userType
          )
        ))
      );
    }

    // ───── Shipments Collection ─────
    match /shipments/{shipmentId} {
      allow create: if request.auth.uid != null &&
                     isExporter(request.auth.uid) &&
                     request.resource.data.exporterId == request.auth.uid;

      allow list: if request.auth.uid != null && isEmployee();

      allow get: if request.auth.uid != null && (
        isEmployee() ||
        (isExporter(request.auth.uid) && resource.data.exporterId == request.auth.uid) ||
        isCarrier(request.auth.uid)
      );

      allow update: if request.auth.uid != null && (
        // Employees can always update
        isEmployee() ||

        // Exporters with constraints
        (isExporter(request.auth.uid) &&
         resource.data.exporterId == request.auth.uid &&
         (
           // Editing draft/scheduled without changing core fields
           (
             (resource.data.status == 'draft' || resource.data.status == 'scheduled') &&
             request.resource.data.exporterId == resource.data.exporterId &&
             request.resource.data.createdAt == resource.data.createdAt
           ) ||

           // Awarding shipment
           (
             resource.data.status == 'live' &&
             request.resource.data.status == 'awarded' &&
             request.resource.data.winningBidId != null &&
             request.resource.data.winningCarrierLegalName ==
               get(/databases/$(database)/documents/users/$(request.resource.data.winningCarrierId)).data.companyDetails.legalName
           )
         )
        ) ||

        // POC updates allowed for awarded parties
        (
          isShipmentAwardedParty(shipmentId, request.auth.uid) &&
          request.resource.data.keys().hasAny([
            'exporterPocFullName','exporterPocPhoneNumber',
            'vendorPocFullName','vendorPocPhoneNumber'
          ])
        )
      );

      allow delete: if request.auth.uid != null &&
                     isExporter(request.auth.uid) &&
                     resource.data.exporterId == request.auth.uid &&
                     resource.data.status == 'draft';

      // ───── Documents Subcollection ─────
      match /documents/{documentId} {
        allow read: if isShipmentAwardedParty(shipmentId, request.auth.uid);

        allow create: if isShipmentAwardedParty(shipmentId, request.auth.uid) &&
                      request.resource.data.uploaderId == request.auth.uid;

        allow delete: if isEmployee() ||
                      (isShipmentAwardedParty(shipmentId, request.auth.uid) &&
                       resource.data.uploaderId == request.auth.uid);
      }
    }

    // ───── Bids Subcollection ─────
    match /shipments/{shipmentId}/bids/{bidId} {
      allow read: if request.auth.uid != null && (
        isEmployee() ||
        (isExporter(request.auth.uid) &&
         getShipment(shipmentId).data.exporterId == request.auth.uid) ||
        (isCarrier(request.auth.uid) &&
         getShipment(shipmentId).data.status == 'live')
      );

      allow create: if request.auth.uid != null &&
                     isCarrier(request.auth.uid) &&
                     request.resource.data.carrierId == request.auth.uid &&
                     getShipment(shipmentId).data.status == 'live';
    }

    // ───── Register Subcollection ─────
    match /shipments/{shipmentId}/register/{carrierId} {
      allow read: if request.auth.uid != null && (
        isEmployee() ||
        (isExporter(request.auth.uid) &&
         getShipment(shipmentId).data.exporterId == request.auth.uid) ||
        (isCarrier(request.auth.uid) && request.auth.uid == carrierId)
      );

      allow create: if request.auth.uid != null &&
                     isCarrier(request.auth.uid) &&
                     request.auth.uid == carrierId &&
                     getShipment(shipmentId).data.status == 'scheduled';
    }

    // ───── CollectionGroup Queries ─────
    match /{documentPath=**}/register/{docId} {
      allow read: if request.auth.uid != null &&
                   isCarrier(request.auth.uid) &&
                   resource.data.carrierId == request.auth.uid;
    }

    match /{documentPath=**}/bids/{bidId} {
      allow read: if request.auth.uid != null &&
                   isCarrier(request.auth.uid) &&
                   resource.data.carrierId == request.auth.uid;
    }
  }
}