rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ───── Helper Functions ─────
    function isExporter(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'exporter';
    }

    function isCarrier(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'carrier';
    }

    function isEmployee(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'employee';
    }

    function getShipment(shipmentId) {
      return get(/databases/$(database)/documents/shipments/$(shipmentId));
    }

    function isShipmentAwardedParty(shipmentId, userId) {
      let shipment = getShipment(shipmentId).data;
      return shipment.status == 'awarded' && (
        isEmployee(userId) ||
        shipment.exporterId == userId ||
        shipment.winningCarrierId == userId
      );
    }

    // ───── Users Collection ─────
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isEmployee(request.auth.uid);
      allow create: if request.auth.uid == userId 
                    && request.resource.data.email == request.auth.token.email;

      // Update rules for user profiles
      allow update: if request.auth.uid != null && (
        // Allow employees to update any user profile
        isEmployee(request.auth.uid) ||
        // Allow users to update their own profile with specific constraints
        (request.auth.uid == userId && (
            // Rule for first-time verification submission
            (
              resource.data.verificationStatus == 'unsubmitted' &&
              request.resource.data.verificationStatus == 'pending' &&
              // Ensure the file path is correct and belongs to the user
              request.resource.data.companyDetails.incorporationCertificatePath.matches('verification-documents/' + userId + '/.*') &&
              // Ensure all required fields are present in the submission
              request.resource.data.companyDetails.keys().hasAll([
                'legalName', 'gstin', 'pan', 'iecCode', 'adCode', 'incorporationCertificateUrl', 'incorporationCertificatePath'
              ])
            ) ||
            // Rule for general profile updates (e.g., changing name)
            // This prevents users from changing their verification status or user type after submission.
            (
              request.resource.data.keys().hasOnly(['name', 'email', 'userType', 'isGstVerified', 'companyDetails', 'verificationStatus', 'gstin']) &&
              request.resource.data.verificationStatus == resource.data.verificationStatus &&
              request.resource.data.userType == resource.data.userType
            )
        ))
      );
    }

    // ───── Shipments Collection ─────
    match /shipments/{shipmentId} {
      allow create: if request.auth.uid != null
                    && isExporter(request.auth.uid)
                    && request.resource.data.exporterId == request.auth.uid;

      allow list: if request.auth.uid != null;

      allow get: if request.auth.uid != null && (
        isEmployee(request.auth.uid) ||
        (isExporter(request.auth.uid) && resource.data.exporterId == request.auth.uid) ||
        isCarrier(request.auth.uid)
      );

      allow update: if request.auth.uid != null && (
        isEmployee(request.auth.uid) ||
        (isExporter(request.auth.uid) &&
          resource.data.exporterId == request.auth.uid &&
          (
            ((resource.data.status == 'draft' || resource.data.status == 'scheduled') &&
             request.resource.data.exporterId == resource.data.exporterId &&
             request.resource.data.createdAt == resource.data.createdAt
            ) ||
            (resource.data.status == 'live' &&
             request.resource.data.status == 'awarded' &&
             request.resource.data.winningBidId != null &&
             request.resource.data.winningCarrierLegalName ==
               get(/databases/$(database)/documents/users/$(request.resource.data.winningCarrierId)).data.companyDetails.legalName
            )
          )
        ) ||
        (isShipmentAwardedParty(shipmentId, request.auth.uid) &&
         request.resource.data.keys().hasAny([
           'exporterPocFullName','exporterPocPhoneNumber','vendorPocFullName','vendorPocPhoneNumber'
         ])
        )
      );

      allow delete: if request.auth.uid != null &&
                     isExporter(request.auth.uid) &&
                     resource.data.exporterId == request.auth.uid &&
                     resource.data.status == 'draft';

      // ───── Documents Subcollection ─────
      match /documents/{documentId} {
        allow read: if isShipmentAwardedParty(shipmentId, request.auth.uid);
        allow create: if isShipmentAwardedParty(shipmentId, request.auth.uid) &&
                      request.resource.data.uploaderId == request.auth.uid;
        allow delete: if isEmployee(request.auth.uid) ||
                      (isShipmentAwardedParty(shipmentId, request.auth.uid) &&
                       resource.data.uploaderId == request.auth.uid);
      }
    }

    // ───── Bids Subcollection ─────
    match /shipments/{shipmentId}/bids/{bidId} {
      allow read: if request.auth.uid != null && (
        isEmployee(request.auth.uid) ||
        (isExporter(request.auth.uid) && getShipment(shipmentId).data.exporterId == request.auth.uid) ||
        (isCarrier(request.auth.uid) && getShipment(shipmentId).data.status == 'live')
      );

      allow create: if request.auth.uid != null &&
                     isCarrier(request.auth.uid) &&
                     request.resource.data.carrierId == request.auth.uid &&
                     getShipment(shipmentId).data.status == 'live';
    }

    // ───── Register Subcollection ─────
    match /shipments/{shipmentId}/register/{carrierId} {
      allow read: if request.auth.uid != null && (
        isEmployee(request.auth.uid) ||
        (isExporter(request.auth.uid) && getShipment(shipmentId).data.exporterId == request.auth.uid) ||
        (isCarrier(request.auth.uid) && request.auth.uid == carrierId)
      );

      allow create: if request.auth.uid != null &&
                     isCarrier(request.auth.uid) &&
                     request.auth.uid == carrierId &&
                     getShipment(shipmentId).data.status == 'scheduled';
    }

    // ───── CollectionGroup Query on Register ─────
    match /{documentPath=**}/register/{docId} {
      allow read: if request.auth.uid != null
                  && isCarrier(request.auth.uid)
                  && resource.data.carrierId == request.auth.uid;
    }

    // ───── CollectionGroup Query on Bids ─────
    match /{documentPath=**}/bids/{bidId} {
      allow read: if request.auth.uid != null
                  && isCarrier(request.auth.uid)
                  && resource.data.carrierId == request.auth.uid;
    }
  }
}